











<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>D√≤ s·ªë - X·ªï s·ªë th√¥ng minh</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        .form-mini .form-label,
        .form-mini .form-control,
        .form-mini .form-select {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-3">
    <h3 class="text-center mb-3">üéØ D√≤ S·ªë X·ªï S·ªë 3 Mi·ªÅn</h3>

    <form id="form-do-so" class="row g-2 form-mini">
        <div class="col-md-2" id="so-danh-field">
            <label class="form-label">S·ªë ƒë√°nh</label>
            <input type="text" class="form-control" name="soDanh" required>
        </div>
        <div class="col-md-2">
            <label class="form-label">C√°ch ƒë√°nh</label>
            <select class="form-select" name="cachDanh" required>
                <option value="2 ch√¢n">2 CH√ÇN</option>
                <option value="3 ch√¢n">3 CH√ÇN</option>
                <option value="ƒë·∫ßu">ƒê·∫¶U</option>
                <option value="ƒëu√¥i">ƒêU√îI</option>
                <option value="l·ªõn">L·ªöN</option>
                <option value="nh·ªè">NH·ªé</option>
                <option value="ƒë·∫ßu ƒëu√¥i">ƒê·∫¶U ƒêU√îI</option>
                <option value="xuy√™n 2">XUY√äN 2</option>
                <option value="xuy√™n 3">XUY√äN 3</option>
                <option value="xuy√™n 4">XUY√äN 4</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Mi·ªÅn</label>
            <select class="form-select" name="mien" required>
                <option value="">--Ch·ªçn--</option>
                <option>MI·ªÄN B·∫ÆC</option>
                <option>MI·ªÄN TRUNG</option>
                <option>MI·ªÄN NAM</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">T√™n ƒë√†i (tu·ª≥ ch·ªçn)</label>
            <input type="text" class="form-control" name="tenDai" placeholder="VD: HCM, LA, 3 ƒê√ÄI">
        </div>
        <div class="col-md-2">
            <label class="form-label">Ng√†y</label>
            <input type="date" class="form-control" name="ngay" required>
        </div>

        <div class="col-md-2" id="tien-danh-field">
            <label class="form-label">Ti·ªÅn ƒë√°nh</label>
            <input type="number" class="form-control" name="tienDanh" min="1">
        </div>

        <div id="nhieu-tien-3chan" class="row d-none">
            <div class="col-md-2">
                <label class="form-label">Ti·ªÅn bao l√¥</label>
                <input type="number" class="form-control" name="tienBaoLo" min="0">
            </div>
            <div class="col-md-2">
                <label class="form-label">Ti·ªÅn Th∆∞·ªüng</label>
                <input type="number" class="form-control" name="tienThuong" min="0">
            </div>
            <div class="col-md-2">
                <label class="form-label">Ti·ªÅn ƒê·∫∑c bi·ªát</label>
                <input type="number" class="form-control" name="tienDacBiet" min="0">
            </div>
        </div>

        <div class="col-12 text-center">
            <button type="submit" class="btn btn-primary px-4">üîç D√≤ s·ªë</button>
        </div>
    </form>

    <hr>

    <div id="ket-qua" class="mt-3"></div>

    <h4 class="mt-4 text-center">üìã K·∫øt Qu·∫£ X·ªï S·ªë Theo Ng√†y</h4>
    <div class="row justify-content-center mb-2">
        <div class="col-md-3">
            <input type="date" id="ngay-ketqua" class="form-control" placeholder="Ch·ªçn ng√†y">
        </div>
        <div class="col-md-2">
            <select id="mien-loc" class="form-select">
                <option value="">T·∫•t c·∫£ mi·ªÅn</option>
                <option>MI·ªÄN B·∫ÆC</option>
                <option>MI·ªÄN TRUNG</option>
                <option>MI·ªÄN NAM</option>
            </select>
        </div>
        <div class="col-md-2">
            <input type="text" id="dai-loc" class="form-control" placeholder="T√™n ƒë√†i (tu·ª≥ ch·ªçn)">
        </div>
        <div class="col-md-2">
            <button class="btn btn-secondary w-100" onclick="taiKetQuaXoSoTheoNgay()">üìã Xem K·∫øt Qu·∫£</button>
        </div>
    </div>

    <div id="bang-ket-qua-3mien" class="table-responsive mt-2"></div>
</div>

<script>
    const form = document.getElementById('form-do-so');
    const cachDanhSelect = form.querySelector('[name="cachDanh"]');
    const tienDanhField = document.getElementById('tien-danh-field');
    const nhieuTienDiv = document.getElementById('nhieu-tien-3chan');
    const soDanhInput = form.querySelector('[name="soDanh"]');

    // ·∫®n/hi·ªán c√°c tr∆∞·ªùng tu·ª≥ theo c√°ch ƒë√°nh
    function updateFormFields() {
        const value = cachDanhSelect.value.toLowerCase();

        if (value === '3 ch√¢n') {
            tienDanhField.classList.add('d-none');
            nhieuTienDiv.classList.remove('d-none');
            soDanhInput.removeAttribute('required');
            soDanhInput.parentElement.classList.remove('d-none');
        } else if (value === 'l·ªõn' || value === 'nh·ªè') {
            // ·∫®n tr∆∞·ªùng s·ªë ƒë√°nh n·∫øu l√† L·ªöN ho·∫∑c NH·ªé
            soDanhInput.value = ''; // xo√° n·∫øu c√≥
            soDanhInput.removeAttribute('required');
            soDanhInput.parentElement.classList.add('d-none');
            tienDanhField.classList.remove('d-none');
            nhieuTienDiv.classList.add('d-none');
        } else {
            // C√°c c√°ch ƒë√°nh b√¨nh th∆∞·ªùng
            soDanhInput.setAttribute('required', 'required');
            soDanhInput.parentElement.classList.remove('d-none');
            tienDanhField.classList.remove('d-none');
            nhieuTienDiv.classList.add('d-none');
        }
    }

    cachDanhSelect.addEventListener('change', updateFormFields);
    window.addEventListener('load', () => {
        updateFormFields();
        taiKetQuaXoSoTheoNgay();
    });

    // G·ª≠i form d√≤ s·ªë
    form.addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(form);
        const cachDanh = formData.get("cachDanh").toLowerCase();

        const data = {
            cachDanh: cachDanh,
            mien: formData.get("mien"),
            tenDai: formData.get("tenDai"),
            ngay: formData.get("ngay"),
        };

        // L·ªõn/nh·ªè kh√¥ng c·∫ßn s·ªë ƒë√°nh
        data.soDanh = (cachDanh === 'l·ªõn' || cachDanh === 'nh·ªè') ? null : formData.get("soDanh");

        // X·ª≠ l√Ω ti·ªÅn ƒë√°nh
        if (cachDanh === '3 ch√¢n') {
            const baoLo = form.querySelector('[name="tienBaoLo"]').value || "0";
            const thuong = form.querySelector('[name="tienThuong"]').value || "0";
            const dacBiet = form.querySelector('[name="tienDacBiet"]').value || "0";
            data.tienDanh = `${baoLo}-${thuong}-${dacBiet}`;
        } else {
            data.tienDanh = form.querySelector('[name="tienDanh"]').value || "0";
        }

        try {
            const response = await fetch('/xoso/doiso', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const ketQua = await response.json();
            document.getElementById('ket-qua').innerHTML = `
                <div class="alert alert-${ketQua.trung ? 'success' : 'danger'}">
                    <strong>K·∫øt qu·∫£:</strong> ${
                ketQua.trung
                    ? `üéâ TR√öNG S·ªê! Tr√∫ng: ${ketQua.tienTrung}ƒë ${ketQua.soDanh ? 'v·ªõi s·ªë ' + ketQua.soDanh : ''} (${ketQua.cachTrung || ''})`
                    : 'üíî KH√îNG TR√öNG'
            }<br>
                    ${ketQua.tienTrungBaoLo !== undefined ? `üí∞ Bao l√¥: ${ketQua.tienTrungBaoLo}<br>` : ''}
                    ${ketQua.tienTrungThuong !== undefined ? `üèÜ Th∆∞·ª£ng: ${ketQua.tienTrungThuong}<br>` : ''}
                    ${ketQua.tienTrungDacBiet !== undefined ? `üéØ ƒê·∫∑c bi·ªát: ${ketQua.tienTrungDacBiet}<br>` : ''}
                </div>
                <pre>${JSON.stringify(ketQua, null, 2)}</pre>
            `;
        } catch (err) {
            document.getElementById('ket-qua').innerHTML = `
                <div class="alert alert-danger">
                    <strong>L·ªói:</strong><br>
                    ${err.message.replaceAll('<', '&lt;')}
                </div>
            `;
        }
    });

    // T·∫£i b·∫£ng k·∫øt qu·∫£ 3 mi·ªÅn
    async function taiKetQuaXoSoTheoNgay() {
        const ngay = document.getElementById('ngay-ketqua').value;
        const mien = document.getElementById('mien-loc').value;
        const dai = document.getElementById('dai-loc').value;

        if (!ngay) {
            alert("Vui l√≤ng ch·ªçn ng√†y c·∫ßn xem k·∫øt qu·∫£!");
            return;
        }

        const params = new URLSearchParams({ ngay });
        if (mien) params.append("mien", mien);
        if (dai) params.append("dai", dai);

        try {
            const response = await fetch(`/xoso/ketqua?${params.toString()}`);
            const data = await response.json();

            let html = '';
            if (data.length === 0) {
                html = '<div class="text-muted">Kh√¥ng c√≥ k·∫øt qu·∫£ n√†o kh·ªõp</div>';
            } else {
                data.forEach(dai => {
                    html += `<h5>${dai.mien} ‚Äì <strong>${dai.tenDai}</strong></h5>`;
                    html += `<table class="table table-bordered table-sm mt-1">
                        <thead><tr><th>Gi·∫£i</th><th>S·ªë tr√∫ng</th></tr></thead>
                        <tbody>
                            ${dai.ketQua.map(kq => `<tr><td>${kq.giai}</td><td>${kq.soTrung}</td></tr>`).join('')}
                        </tbody>
                    </table>`;
                });
            }

            document.getElementById('bang-ket-qua-3mien').innerHTML = html;

        } catch (e) {
            document.getElementById('bang-ket-qua-3mien').innerHTML =
                '<div class="text-danger">Kh√¥ng t·∫£i ƒë∆∞·ª£c k·∫øt qu·∫£. Ki·ªÉm tra k·∫øt n·ªëi ho·∫∑c d·ªØ li·ªáu.</div>';
        }
    }
</script>

</body>
</html>
